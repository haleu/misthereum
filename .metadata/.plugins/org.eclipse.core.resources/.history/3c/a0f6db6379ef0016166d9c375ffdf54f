package lab1;

import Sim.*;
import java.util.Random;

public class LossyLink extends Link{
	
	double Delay;
	double Jitter;
	int Probability;
	public static int packetCounter = 0;
	
	private SimEnt _connectorA=null;
	private SimEnt _connectorB=null;
	
	public LossyLink(double Delay, double Jitter, int Probability)
	{
		super();
		this.Delay = Delay;
		this.Jitter = Jitter;
		this.Probability = Probability;
	}
	
	public void setConnector(SimEnt connectTo)
	{
		if (_connectorA == null) 
			_connectorA=connectTo;
		else
			_connectorB=connectTo;
	}
	
	public void recv(SimEnt src, Event ev)
	{
		if (ev instanceof Message)
		{
			Random rand = new Random();
			double sendTime;
			
			// SendTime will determine the amount of time using Delay and a random number with Jitter as a max number.
			sendTime = (rand.nextDouble() + rand.nextInt())%Jitter + Delay;
			// Will check if the packet should be dropped
			if(rand.nextInt(100)+1 <= Probability)
			{
				System.out.println("Link recv msg, dropping it" + "\n amount of packet dropped  "+LossyLink.packetCounter);
				packetCounter++;
				return;
			}
			
			System.out.println("Link recv msg, passes it through, with delay/jitter: " + sendTime);
			if (src == _connectorA)
			{
				send(_connectorB, ev, sendTime);
			}
			else
			{
				send(_connectorA, ev, sendTime);
			}
		}
	}

}
